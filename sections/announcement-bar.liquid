{% liquid
  assign bg_color = section.settings.bg_color
  assign text_color = section.settings.text_color
  assign accent_color = section.settings.accent_color
%}

<section
  id="shopify-section-{{ section.id }}"
  class="vb-announcement"
  style="
    --vb-bg: {{ bg_color }};
    --vb-text: {{ text_color }};
    --vb-accent: {{ accent_color }};
  "
>
  <div class="vb-announcement__inner page-width">
    <div class="vb-announcement__messages" data-rotate-wrap>
      {% if section.blocks.size > 0 %}
        {% for block in section.blocks %}
          <div
            class="vb-announcement__item{% if forloop.first %} is-active{% endif %}"
            data-rotate-item
            {{ block.shopify_attributes }}
          >
            {% if block.settings.link != blank %}
              <a href="{{ block.settings.link }}" class="vb-announcement__link">{{ block.settings.text }}</a>
            {% else %}
              <span>{{ block.settings.text }}</span>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <div class="vb-announcement__item is-active" data-rotate-item>
          <span>{{ section.settings.fallback_text }}</span>
        </div>
      {% endif %}
    </div>

    {% if section.settings.show_countdown and section.settings.countdown_end != blank %}
      <div
        class="vb-announcement__countdown"
        data-countdown
        data-end="{{ section.settings.countdown_end | escape }}"
        aria-live="polite"
      >
        <span class="vb-announcement__countdown-label">{{ section.settings.countdown_label }}</span>
        <span class="vb-announcement__countdown-time" data-countdown-time>00:00:00</span>
      </div>
    {% endif %}
  </div>
</section>

<style>
  #shopify-section-{{ section.id }}.vb-announcement {
    background: var(--vb-bg);
    color: var(--vb-text);
    border-bottom: 1px solid #dce9df;
    border-bottom: 1px solid color-mix(in srgb, var(--vb-accent) 24%, #dce9df);
  }

  #shopify-section-{{ section.id }} .vb-announcement__inner {
    min-height: 44px;
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.35rem;
    align-items: center;
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
  }

  #shopify-section-{{ section.id }} .vb-announcement__messages {
    position: relative;
    min-height: 1.2rem;
  }

  #shopify-section-{{ section.id }} .vb-announcement__item {
    display: none;
    font-size: 0.84rem;
    line-height: 1.3;
    letter-spacing: 0.01em;
    text-align: center;
  }

  #shopify-section-{{ section.id }} .vb-announcement__item.is-active {
    display: block;
  }

  #shopify-section-{{ section.id }} .vb-announcement__link {
    color: inherit;
    text-decoration: none;
    border-bottom: 1px solid transparent;
  }

  #shopify-section-{{ section.id }} .vb-announcement__link:hover {
    border-bottom-color: currentColor;
  }

  #shopify-section-{{ section.id }} .vb-announcement__countdown {
    justify-self: center;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.2rem 0.55rem;
    border-radius: 999px;
    border: 1px solid #cfe1d3;
    border: 1px solid color-mix(in srgb, var(--vb-accent) 42%, #cfe1d3);
    background: #ffffff;
    font-size: 0.76rem;
    line-height: 1.2;
  }

  #shopify-section-{{ section.id }} .vb-announcement__countdown-label {
    color: #48634e;
  }

  #shopify-section-{{ section.id }} .vb-announcement__countdown-time {
    color: #183923;
    font-weight: 700;
    letter-spacing: 0.03em;
  }

  #shopify-section-{{ section.id }} .vb-announcement__countdown.is-ended {
    opacity: 0.7;
  }

  @media screen and (min-width: 750px) {
    #shopify-section-{{ section.id }} .vb-announcement__inner {
      grid-template-columns: 1fr auto;
      gap: 0.85rem;
      min-height: 48px;
    }

    #shopify-section-{{ section.id }} .vb-announcement__item {
      text-align: left;
      font-size: 0.87rem;
    }

    #shopify-section-{{ section.id }} .vb-announcement__countdown {
      justify-self: end;
    }
  }
</style>

<script>
  (() => {
    const section = document.getElementById('shopify-section-{{ section.id }}');
    if (!section) return;

    const rotateEnabled = {{ section.settings.enable_rotation | json }};
    const rotateSpeed = {{ section.settings.rotation_speed | json }} * 1000;
    const items = section.querySelectorAll('[data-rotate-item]');
    let activeIndex = 0;

    const showIndex = (index) => {
      items.forEach((item, i) => item.classList.toggle('is-active', i === index));
    };

    if (rotateEnabled && items.length > 1) {
      setInterval(() => {
        activeIndex = (activeIndex + 1) % items.length;
        showIndex(activeIndex);
      }, Math.max(2000, rotateSpeed));
    }

    const countdownWrap = section.querySelector('[data-countdown]');
    if (countdownWrap) {
      const endRaw = countdownWrap.getAttribute('data-end');
      const out = countdownWrap.querySelector('[data-countdown-time]');
      const endDate = new Date(endRaw).getTime();

      const pad = (num) => String(num).padStart(2, '0');
      const updateCountdown = () => {
        if (!out || !endDate || Number.isNaN(endDate)) return;
        const now = Date.now();
        const diff = endDate - now;

        if (diff <= 0) {
          out.textContent = '00:00:00';
          countdownWrap.classList.add('is-ended');
          return;
        }

        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        out.textContent = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
      };

      updateCountdown();
      setInterval(updateCountdown, 1000);
    }
  })();
</script>

{% schema %}
{
  "name": "Announcement Bar",
  "tag": "section",
  "class": "section section-announcement-bar",
  "settings": [
    {
      "type": "text",
      "id": "fallback_text",
      "label": "Fallback text",
      "default": "Envio gratis desde determinado monto."
    },
    {
      "type": "checkbox",
      "id": "enable_rotation",
      "label": "Enable rotating messages",
      "default": true
    },
    {
      "type": "range",
      "id": "rotation_speed",
      "label": "Rotation speed (seconds)",
      "min": 2,
      "max": 10,
      "step": 1,
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "show_countdown",
      "label": "Show countdown timer",
      "default": false
    },
    {
      "type": "text",
      "id": "countdown_label",
      "label": "Countdown label",
      "default": "Termina en"
    },
    {
      "type": "text",
      "id": "countdown_end",
      "label": "Countdown end datetime (ISO format)",
      "info": "Example: 2026-12-31T23:59:59-03:00",
      "default": "2026-12-31T23:59:59-03:00"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#f8fbf8"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#1f2a1f"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent color",
      "default": "#9bbfa4"
    }
  ],
  "blocks": [
    {
      "type": "item",
      "name": "Message",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Text",
          "default": "15% off en tu primera compra al suscribirte"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        }
      ]
    }
  ],
  "max_blocks": 8,
  "presets": [
    {
      "name": "Announcement Bar",
      "blocks": [
        {
          "type": "item"
        },
        {
          "type": "item"
        },
        {
          "type": "item"
        }
      ]
    }
  ]
}
{% endschema %}
