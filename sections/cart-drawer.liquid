<section
  id="shopify-section-{{ section.id }}"
  class="vb-cart-drawer-shell"
  style="
    --vb-bg: {{ section.settings.bg_color }};
    --vb-text: {{ section.settings.text_color }};
    --vb-accent: {{ section.settings.accent_color }};
    --vb-border: {{ section.settings.border_color }};
  "
>
  <button class="vb-cart-drawer-open" type="button" data-cart-drawer-open>
    {{ section.settings.open_label }}
    <span data-cart-count>0</span>
  </button>

  <div class="vb-cart-drawer-overlay" data-cart-drawer-overlay></div>

  <aside class="vb-cart-drawer" data-cart-drawer aria-hidden="true" role="dialog" aria-label="{{ section.settings.aria_label | escape }}">
    <header class="vb-cart-drawer__header">
      <h2>{{ section.settings.heading }}</h2>
      <button class="vb-cart-drawer__close" type="button" aria-label="Close cart" data-cart-drawer-close>
        <svg class="vb-cart-drawer__close-icon" width="16" height="16" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
          <path d="M3 3L13 13M13 3L3 13" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
        </svg>
      </button>
    </header>

    <div class="vb-cart-drawer__body">
      <div class="vb-cart-items" data-cart-items></div>

      <div class="vb-cart-empty" data-cart-empty hidden>
        <p>{{ section.settings.empty_text }}</p>
      </div>

      <div class="vb-cart-upsell">
        {% if section.settings.upsell_heading != blank %}
          <h3>{{ section.settings.upsell_heading }}</h3>
        {% endif %}
        <div class="vb-cart-upsell__grid">
          {% assign upsell_collection = section.settings.upsell_collection %}
          {% if upsell_collection != blank and upsell_collection.products_count > 0 %}
            {% for product in upsell_collection.products limit: section.settings.upsell_limit %}
              <article class="vb-cart-upsell__item">
                <a href="{{ product.url }}" class="vb-cart-upsell__image">
                  {% if product.featured_image %}
                    {{
                      product.featured_image
                      | image_url: width: 320
                      | image_tag:
                        loading: 'lazy',
                        widths: '120,180,240,320',
                        sizes: '54px',
                        alt: product.featured_image.alt
                    }}
                  {% else %}
                    {{ 'product-1' | placeholder_svg_tag: 'vb-placeholder' }}
                  {% endif %}
                </a>
                <div>
                  <p><a href="{{ product.url }}">{{ product.title }}</a></p>
                  <span>{{ product.price | money }}</span>
                </div>
              </article>
            {% endfor %}
          {% else %}
            <p class="vb-cart-upsell__fallback">{{ section.settings.upsell_fallback }}</p>
          {% endif %}
        </div>
      </div>
    </div>

    <footer class="vb-cart-drawer__footer">
      <div class="vb-cart-subtotal">
        <span>{{ section.settings.subtotal_label }}</span>
        <strong data-cart-subtotal>{{ 0 | money }}</strong>
      </div>
      <a href="{{ routes.cart_url }}" class="vb-cart-link">{{ section.settings.view_cart_label }}</a>
      <a href="{{ routes.checkout_url }}" class="vb-cart-checkout">{{ section.settings.checkout_label }}</a>
    </footer>
  </aside>
</section>

<style>
  #shopify-section-{{ section.id }}.vb-cart-drawer-shell {
    color: var(--vb-text);
  }

  #shopify-section-{{ section.id }} .vb-cart-drawer-open {
    border: 1px solid var(--vb-border);
    background: #fff;
    color: var(--vb-text);
    border-radius: 999px;
    padding: 0.58rem 0.9rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.86rem;
  }

  #shopify-section-{{ section.id }} .vb-cart-drawer-open span {
    background: var(--vb-accent);
    color: #102114;
    border-radius: 999px;
    min-width: 1.2rem;
    height: 1.2rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.74rem;
    padding: 0 0.35rem;
  }

  #shopify-section-{{ section.id }} .vb-cart-drawer-overlay {
    position: fixed;
    inset: 0;
    background: rgba(17, 27, 19, 0.32);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 59;
  }

  #shopify-section-{{ section.id }} .vb-cart-drawer {
    position: fixed;
    top: 0;
    right: 0;
    width: min(420px, 100vw);
    height: 100vh;
    height: 100dvh;
    background: var(--vb-bg);
    border-left: 1px solid var(--vb-border);
    transform: translateX(104%);
    transition: transform 0.25s ease;
    z-index: 60;
    display: grid;
    grid-template-rows: auto 1fr auto;
  }

  #shopify-section-{{ section.id }} .vb-cart-drawer.is-open {
    transform: translateX(0);
  }

  #shopify-section-{{ section.id }} .vb-cart-drawer-overlay.is-open {
    opacity: 1;
    pointer-events: all;
  }

  #shopify-section-{{ section.id }} .vb-cart-drawer__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.8rem;
    padding: 0.9rem;
    border-bottom: 1px solid var(--vb-border);
  }

  #shopify-section-{{ section.id }} .vb-cart-drawer__header h2 {
    margin: 0;
    font-size: 1rem;
  }

  #shopify-section-{{ section.id }} .vb-cart-drawer__close {
    border: 0;
    background: transparent;
    color: var(--vb-text);
    width: 2rem;
    height: 2rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    line-height: 0;
    cursor: pointer;
  }

  #shopify-section-{{ section.id }} .vb-cart-drawer__close-icon {
    display: block;
  }

  #shopify-section-{{ section.id }} .vb-cart-drawer__body {
    overflow-y: auto;
    padding: 0.9rem;
    display: grid;
    gap: 1rem;
    align-content: start;
  }

  #shopify-section-{{ section.id }} .vb-cart-items {
    display: grid;
    gap: 0.65rem;
  }

  #shopify-section-{{ section.id }} .vb-cart-item {
    display: grid;
    grid-template-columns: 68px 1fr;
    gap: 0.6rem;
    border: 1px solid var(--vb-border);
    border-radius: 0.8rem;
    padding: 0.55rem;
    background: #fff;
  }

  #shopify-section-{{ section.id }} .vb-cart-item img {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 0.5rem;
    display: block;
  }

  #shopify-section-{{ section.id }} .vb-cart-item h4 {
    margin: 0;
    font-size: 0.84rem;
    line-height: 1.35;
  }

  #shopify-section-{{ section.id }} .vb-cart-item h4 a {
    color: inherit;
    text-decoration: none;
  }

  #shopify-section-{{ section.id }} .vb-cart-item p {
    margin: 0.2rem 0 0;
    font-size: 0.75rem;
    color: #596a5d;
  }

  #shopify-section-{{ section.id }} .vb-cart-item__meta {
    margin-top: 0.35rem;
    display: flex;
    gap: 0.55rem;
    align-items: center;
    font-size: 0.76rem;
  }

  #shopify-section-{{ section.id }} .vb-cart-item__meta strong {
    font-size: 0.8rem;
  }

  #shopify-section-{{ section.id }} .vb-cart-empty {
    border: 1px dashed var(--vb-border);
    border-radius: 0.8rem;
    padding: 0.85rem;
    font-size: 0.86rem;
    color: #4d5d50;
    background: #fff;
  }

  #shopify-section-{{ section.id }} .vb-cart-empty p {
    margin: 0;
  }

  #shopify-section-{{ section.id }} .vb-cart-upsell h3 {
    margin: 0 0 0.5rem;
    font-size: 0.9rem;
  }

  #shopify-section-{{ section.id }} .vb-cart-upsell__grid {
    display: grid;
    gap: 0.55rem;
  }

  #shopify-section-{{ section.id }} .vb-cart-upsell__item {
    display: grid;
    grid-template-columns: 54px 1fr;
    gap: 0.55rem;
    border: 1px solid var(--vb-border);
    border-radius: 0.7rem;
    padding: 0.45rem;
    background: #fff;
  }

  #shopify-section-{{ section.id }} .vb-cart-upsell__image img,
  #shopify-section-{{ section.id }} .vb-cart-upsell__image svg {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 0.45rem;
    display: block;
  }

  #shopify-section-{{ section.id }} .vb-cart-upsell__item p {
    margin: 0;
    font-size: 0.78rem;
    line-height: 1.35;
  }

  #shopify-section-{{ section.id }} .vb-cart-upsell__item p a {
    color: inherit;
    text-decoration: none;
  }

  #shopify-section-{{ section.id }} .vb-cart-upsell__item span {
    display: block;
    margin-top: 0.2rem;
    font-size: 0.75rem;
    color: #56685a;
  }

  #shopify-section-{{ section.id }} .vb-cart-upsell__fallback {
    margin: 0;
    font-size: 0.8rem;
    color: #5d6e60;
  }

  #shopify-section-{{ section.id }} .vb-cart-drawer__footer {
    border-top: 1px solid var(--vb-border);
    padding: 0.9rem;
    display: grid;
    gap: 0.55rem;
    background: #fff;
  }

  #shopify-section-{{ section.id }} .vb-cart-subtotal {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.86rem;
  }

  #shopify-section-{{ section.id }} .vb-cart-subtotal strong {
    font-size: 0.92rem;
  }

  #shopify-section-{{ section.id }} .vb-cart-link {
    text-decoration: none;
    color: var(--vb-text);
    border: 1px solid var(--vb-border);
    border-radius: 999px;
    padding: 0.62rem 0.9rem;
    text-align: center;
    font-size: 0.84rem;
  }

  #shopify-section-{{ section.id }} .vb-cart-checkout {
    text-decoration: none;
    background: var(--vb-accent);
    border: 1px solid var(--vb-accent);
    color: #102114;
    border-radius: 999px;
    padding: 0.7rem 0.95rem;
    text-align: center;
    font-size: 0.86rem;
    font-weight: 600;
  }
</style>

<script>
  (() => {
    const root = document.getElementById('shopify-section-{{ section.id }}');
    if (!root) return;

    const drawer = root.querySelector('[data-cart-drawer]');
    const overlay = root.querySelector('[data-cart-drawer-overlay]');
    const openButton = root.querySelector('[data-cart-drawer-open]');
    const closeButton = root.querySelector('[data-cart-drawer-close]');
    const itemsWrap = root.querySelector('[data-cart-items]');
    const subtotalEl = root.querySelector('[data-cart-subtotal]');
    const countEl = root.querySelector('[data-cart-count]');
    const emptyWrap = root.querySelector('[data-cart-empty]');
    const moneyFormat = {{ shop.money_format | json }};

    const formatMoney = (cents) => {
      if (window.Shopify && typeof window.Shopify.formatMoney === 'function') {
        return window.Shopify.formatMoney(cents, moneyFormat);
      }
      return `${(cents / 100).toFixed(2)}`;
    };

    const openDrawer = () => {
      drawer.classList.add('is-open');
      overlay.classList.add('is-open');
      drawer.setAttribute('aria-hidden', 'false');
      document.documentElement.style.overflow = 'hidden';
      loadCart();
    };

    const closeDrawer = () => {
      drawer.classList.remove('is-open');
      overlay.classList.remove('is-open');
      drawer.setAttribute('aria-hidden', 'true');
      document.documentElement.style.overflow = '';
    };

    const renderItems = (cart) => {
      itemsWrap.innerHTML = '';
      countEl.textContent = cart.item_count;
      subtotalEl.textContent = formatMoney(cart.total_price);

      if (!cart.items.length) {
        emptyWrap.hidden = false;
        return;
      }

      emptyWrap.hidden = true;
      cart.items.forEach((item) => {
        const image = item.image ? `<img src="${item.image}" alt="${item.product_title}">` : '';
        const variant = item.variant_title && item.variant_title !== 'Default Title' ? `<p>${item.variant_title}</p>` : '';

        const line = document.createElement('article');
        line.className = 'vb-cart-item';
        line.innerHTML = `
          <a href="${item.url || '#'}">${image}</a>
          <div>
            <h4><a href="${item.url || '#'}">${item.product_title}</a></h4>
            ${variant}
            <div class="vb-cart-item__meta">
              <span>Qty: ${item.quantity}</span>
              <strong>${formatMoney(item.final_line_price)}</strong>
            </div>
          </div>
        `;
        itemsWrap.appendChild(line);
      });
    };

    const loadCart = async () => {
      try {
        const response = await fetch(`${window.Shopify?.routes?.root || '/'}cart.js`, { headers: { Accept: 'application/json' } });
        if (!response.ok) return;
        const cart = await response.json();
        renderItems(cart);
      } catch (e) {
        console.error('Cart drawer load error', e);
      }
    };

    openButton?.addEventListener('click', openDrawer);
    closeButton?.addEventListener('click', closeDrawer);
    overlay?.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeDrawer();
    });

    document.addEventListener('cart:refresh', loadCart);
    loadCart();
  })();
</script>

{% schema %}
{
  "name": "Cart drawer",
  "tag": "section",
  "class": "section section-cart-drawer",
  "settings": [
    {
      "type": "text",
      "id": "aria_label",
      "label": "Accessibility label",
      "default": "Cart drawer"
    },
    {
      "type": "text",
      "id": "open_label",
      "label": "Open button label",
      "default": "Cart"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Drawer heading",
      "default": "Your cart"
    },
    {
      "type": "text",
      "id": "empty_text",
      "label": "Empty cart message",
      "default": "Your cart is empty."
    },
    {
      "type": "text",
      "id": "subtotal_label",
      "label": "Subtotal label",
      "default": "Subtotal"
    },
    {
      "type": "text",
      "id": "view_cart_label",
      "label": "View cart button label",
      "default": "View cart"
    },
    {
      "type": "text",
      "id": "checkout_label",
      "label": "Checkout button label",
      "default": "Checkout"
    },
    {
      "type": "text",
      "id": "upsell_heading",
      "label": "Upsell heading",
      "default": "You may also like"
    },
    {
      "type": "collection",
      "id": "upsell_collection",
      "label": "Upsell collection"
    },
    {
      "type": "range",
      "id": "upsell_limit",
      "label": "Upsell items",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 2
    },
    {
      "type": "text",
      "id": "upsell_fallback",
      "label": "Upsell fallback text",
      "default": "Select an upsell collection to show recommendations."
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Drawer background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#1f2a1f"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent color",
      "default": "#9bbfa4"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border color",
      "default": "#e2ebe4"
    }
  ],
  "presets": [
    {
      "name": "Cart drawer"
    }
  ]
}
{% endschema %}




